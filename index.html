<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon TCG Pocket Unpack Simulator</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial; margin: 20px; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 5px; overflow-x: auto; }
        h1 { color: #333; }
        #output { margin-top: 20px; border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; }
    </style>
</head>

<body>
    <h1>Pokemon TCG Pocket Unpack Simulator</h1>

    <div class="checkbox-group">
        <label for="drawUntilAllCardsOwned">Draw Until All Cards Owned in Pack:</label>
        <input type="checkbox" id="drawUntilAllCardsOwned" />
    </div>

    <div class="checkbox-group" id="completeAllPacksGroup" style="display: none;">
        <label for="completeAllPacks">Complete All Packs:</label>
        <input type="checkbox" id="completeAllPacks" />
    </div>

    <div class="checkbox-group" id="completenessSliderGroup" style="display: none;">
        <label for="completenessSlider">Select Completeness:</label>
        <input type="range" id="completenessSlider" min="0" max="100" value="100" />
        <span id="completenessValue">100%</span>
    </div>

    <div class="checkbox-group" id="simulationGroup">
        <label for="numberSimulations">Simulations Count:</label>
        <input type="number" id="numberSimulations" value="10000" min="1" max="10000" />
    </div>

    <div class="checkbox-group" id="dailyQuestGroup" style="display: none;">
        <label for="completeDailyQuest">Complete Daily Quest:</label>
        <input type="checkbox" id="completeDailyQuest" />
        <span class="info-icon-tooltip" data-tooltip="dailyQuest" title="Click for more info">ℹ️</span>
    </div>

    <div class="checkbox-group" id="dailyThanksGroup" style="display: none;">
        <label for="completeDailyThanks">Complete Daily Thanks:</label>
        <input type="checkbox" id="completeDailyThanks" />
        <span class="info-icon-tooltip" data-tooltip="dailyThanks" title="Click for more info">ℹ️</span>
    </div>

    <div class="checkbox-group" id="drawEachCardTwiceGroup" style="display: none;">
        <label for="drawEachCardTwiceCheckbox">Draw each card x2:</label>
        <input type="checkbox" id="drawEachCardTwiceCheckbox" />
        <span class="info-icon-tooltip" data-tooltip="drawEachCardTwice" title="Click for more info">ℹ️</span>
    </div>

    <div class="checkbox-group" id="excludeRarityGroup">
        <label for="excludeCrownCards">Exclude Crown ♛ Cards:</label>
        <input type="checkbox" id="excludeCrownCards" />
        <span class="info-icon-tooltip" data-tooltip="excludeCrown" title="Click for more info">ℹ️</span>
        <br>

        <label for="excludeStarCards">Exclude Star ☆ Cards:</label>
        <input type="checkbox" id="excludeStarCards" />
        <span class="info-icon-tooltip" data-tooltip="excludeStar" title="Click for more info">ℹ️</span>
    </div>

    <script>
        $(document).ready(function () {
            const $drawUntilAllCardsOwned = $('#drawUntilAllCardsOwned');
            const $completeAllPacksGroup = $('#completeAllPacksGroup');
            const $simulationGroup = $('#simulationGroup');
            const $dailyQuestGroup = $('#dailyQuestGroup');
            const $dailyThanksGroup = $('#dailyThanksGroup');
            const $ownEachCardGroup = $('#drawEachCardTwiceGroup');
            const $completenessSliderGroup = $('#completenessSliderGroup');


            $drawUntilAllCardsOwned.change(function () {
                const isChecked = this.checked;
                $completeAllPacksGroup.toggle(isChecked);
                $completenessSliderGroup.toggle(isChecked);
                $dailyQuestGroup.toggle(isChecked);
                $dailyThanksGroup.toggle(isChecked);
                $ownEachCardGroup.toggle(isChecked);
                $simulationGroup.toggle(!isChecked);
            });

            $('#completenessSlider').on('input', function () {
                $('#completenessValue').text(this.value + '%');
            });
        });
    </script>

    <div class="pack-selection">
        <label for="targetPack">Choose a pack to open:</label>
        <select id="targetPack">
            <option value="Mewtwo">Mewtwo</option>
            <option value="Charizard">Charizard</option>
            <option value="Pikachu">Pikachu</option>
        </select>
    </div>

    <div class="language-selection" style="display: none;">
        <label for="languageSelect">Choose Language:</label>
        <select id="languageSelect">
            <option value="en">English</option>
            <option value="zhhk">正體中文 (香港) - 未完成</option>
        </select>
    </div>

    <button id="runSimulation">Start Unpacking</button>
    <table id="output">
        <div id="opened"></div>
        <div id="owned"></div>
        <thead>
            <tr>
                <th style="text-align: left; width: 25%;">Name</th>
                <th style="text-align: left; width: 25%;">Rarity</th>
                <th style="text-align: left; width: 25%;">Count</th>
                <th style="text-align: left; width: 25%;">Pack</th>
            </tr>
        </thead>
        <tbody>
            <!-- Card data will be appended here -->
        </tbody>
    </table>

    <canvas id="daysChart" width="400" height="200"></canvas> <!-- Canvas for the chart -->

    <script>
        $(document).ready(function () {
            function setupTooltip(selector, message) {
                $(selector).on('click', function () {
                    alert(message);
                });
            }

            setupTooltip('.info-icon-tooltip[data-tooltip="dailyQuest"]', 'Free Hourglass x4 after completing the daily quest.');
            setupTooltip('.info-icon-tooltip[data-tooltip="dailyThanks"]', 'Free Shop ticket x5 after receiving Thanks or Likes 5 times. (1.67 Hourglass / days in total)');
            setupTooltip('.info-icon-tooltip[data-tooltip="excludeCrown"]', 'Exclude Crown ♛ Cards when counting owned cards. You can still draw them.');
            setupTooltip('.info-icon-tooltip[data-tooltip="excludeStar"]', 'Exclude Star ☆ Cards when counting owned cards. You can still draw them.');
            setupTooltip('.info-icon-tooltip[data-tooltip="drawEachCardTwice"]', 'Will only count as owned if the card is drawn twice.');
        });
    </script>

    <script type="module">
        import { RARITIES, PACK_RATES, DRAW_RATES, CARD_LIST } from './data.js';

        class TCGPSimulator {
            static RARITIES = RARITIES;
            static PACK_RATES = PACK_RATES;
            static DRAW_RATES = DRAW_RATES;
            static CARD_LIST = CARD_LIST;

            constructor() {
                this.totalDaysData = []; // Initialize the array to store total days
                this.chart = null; // Initialize chart variable
            }

            openPack(drawCounts, targetPack, language) {
                const drawnCards = {};
                const filteredCards = TCGPSimulator.CARD_LIST.filter(card => card.pack === targetPack || card.pack === 'All');
                const drawRates = TCGPSimulator.DRAW_RATES[Math.random() < TCGPSimulator.PACK_RATES[1] ? 'rare' : 'regular'];

                drawRates.forEach(rate => {
                    const card = this.randomChoice(filteredCards, targetPack, rate);
                    drawnCards[card.id] = (drawnCards[card.id] || 0) + 1;
                    drawCounts[card.id] = (drawCounts[card.id] || 0) + 1;
                });

                return drawnCards;
            }

            async runSimulator(numberSimulations = 500, targetPack = 'Charizard', language = 'en') {
                $('#opened').text('');
                const drawUntilAllCardsOwned = $('#drawUntilAllCardsOwned').is(':checked');

                if (drawUntilAllCardsOwned) {
                    const numberOfSimulations = 1000;

                    const promises = Array.from({ length: numberOfSimulations }, () =>  {
                        const drawCounts = {};
                        const packsOpenedHistory = [];
                        const completedPacks = []
                        this.simulateUntilAllCardsOwned(drawCounts, packsOpenedHistory, targetPack, language, completedPacks);

                        const totalDays = this.getOpenedCount(packsOpenedHistory, targetPack);
                        this.saveTotalDays(totalDays);

                        if (numberOfSimulations <= 1) {
                            this.updateOutputTable(drawCounts, packsOpenedHistory, targetPack, language);
                            this.updateOpenedCount(packsOpenedHistory, targetPack);
                        }
                    });
                    await Promise.all(promises);

                    if (numberOfSimulations > 1) {
                        $('#output').hide();
                        $('#daysChart').show(); // Show the day graph
                        this.updateChart();
                    } else {
                        $('#output').show();
                        $('#daysChart').hide(); // Hide the day graph
                    }
                } else {
                    const drawCounts = {};
                    const packsOpenedHistory = [];
                    this.simulateFixedCount(drawCounts, packsOpenedHistory, numberSimulations, targetPack, language);
                    this.updateOutputTable(drawCounts, packsOpenedHistory, targetPack, language);
                    this.updateOpenedCount(packsOpenedHistory, targetPack);
                }
            }

            simulateUntilAllCardsOwned(drawCounts, packsOpenedHistory, targetPack, language, completedPacks) {
                let currentCount = 0;
                const completenessPercentage = parseFloat($('#completenessValue').text()) || 0;
                const filteredCards = this.getFilteredCards(targetPack);
                const ownedCards = new Set()

                while (ownedCards.size < filteredCards.length) {
                    const drawnCards = this.openPack(drawCounts, targetPack, language);
                    Object.keys(drawnCards).forEach(cardId => {
                        if (this.isCardOwned(drawCounts, cardId)) 
                            ownedCards.add(cardId);
                    });
                    packsOpenedHistory.push(drawnCards);
                    currentCount++;

                    const ownedPercentage = (ownedCards.size / filteredCards.length) * 100;
                    if (ownedPercentage >= completenessPercentage) {
                        if ($('#completeAllPacks').is(':checked')) {
                            completedPacks.push(targetPack);
                            const availablePacks = $('#targetPack option').map(function () {
                                return $(this).val();
                            }).get().filter(pack => !completedPacks.includes(pack));

                            if (availablePacks.length > 0) {
                                const nextPack = availablePacks[0];
                                this.simulateUntilAllCardsOwned(drawCounts, packsOpenedHistory, nextPack, language, completedPacks);
                            }
                        }

                        break;
                    }
                }
            }

            simulateFixedCount(drawCounts, packsOpenedHistory, numberSimulations, targetPack, language) {
                for (let i = 0; i < numberSimulations; i++) {
                    packsOpenedHistory.push(this.openPack(drawCounts, targetPack, language));
                }
            }

            getOpenedCount(packsOpenedHistory, targetPack) {
                const adjustedPacksPerDay = (24 + (1 / 3) + ($('#completeDailyQuest').is(':checked') ? 4 : 0) + ($('#completeDailyThanks').is(':checked') ? (5 / 6) : 0)) / 12;
                return Math.ceil(packsOpenedHistory.length / adjustedPacksPerDay);
            }

            updateOpenedCount(packsOpenedHistory, targetPack) {
                const totalDays = this.getOpenedCount(packsOpenedHistory, targetPack);
                $('#opened').text(`Opened: ${packsOpenedHistory.length} (Total Days: ${totalDays})`);
                return totalDays;
            }

            updateOutputTable(drawCounts, packsOpenedHistory, targetPack, language) {
                const finalDrawnCards = this.aggregateDrawnCards(packsOpenedHistory);
                const sortedCards = this.sortCards(finalDrawnCards);
                sortedCards.forEach(({ card, count }) => {
                    $('#output tbody').append(`<tr><td>(${card.id}) ${card[`name-${language}`]}</td><td>${card.rarity}</td><td>${count}</td><td>${card.pack}</td></tr>`);
                });
                $('#owned').text(`Owned: ${this.getOwnedCount(drawCounts, finalDrawnCards)}/${this.getTotalCardsInPack(targetPack)}`);
            }

            randomChoice(array, targetPack, weights) {
                const randomNum = Math.random();
                let cumulativeWeight = 0;
                for (let i = 0; i < array.length; i++) {
                    cumulativeWeight += weights[i];
                    if (randomNum < cumulativeWeight) {
                        const filteredCards = array.filter(card => card.rarity === TCGPSimulator.RARITIES[i]);
                        return filteredCards[Math.floor(Math.random() * filteredCards.length)];
                    }
                }
            }

            getFilteredCards(targetPack, includeAll = true) {
                const excludeCrownCards = $('#excludeCrownCards').is(':checked');
                const excludeStarCards = $('#excludeStarCards').is(':checked');
                return TCGPSimulator.CARD_LIST.filter(card =>
                    (card.pack === targetPack || (includeAll && card.pack === 'All')) &&
                    (!excludeCrownCards || card.rarity !== '♛') &&
                    (!excludeStarCards || !card.rarity.startsWith('☆'))
                );
            }

            isCardOwned(drawCounts, cardId) {
                const card = TCGPSimulator.CARD_LIST.find(c => c.id === cardId);

                const excludeCrown = $('#excludeCrownCards').is(':checked') && card.rarity === '♛';
                const excludeStar = $('#excludeStarCards').is(':checked') && card.rarity.startsWith('☆');
                const drawCount = drawCounts[cardId] || 0;
                const drawEachCardTwiceChecked = $('#drawEachCardTwiceCheckbox').is(':checked');

                return !(excludeCrown || excludeStar) && (drawEachCardTwiceChecked ? drawCount >= 2 : true);
            }

            aggregateDrawnCards(packsOpenedHistory) {
                return packsOpenedHistory.reduce((acc, drawnCards) => {
                    Object.keys(drawnCards).forEach(cardId => {
                        const card = TCGPSimulator.CARD_LIST.find(c => c.id === cardId);
                        if (card) {
                            acc[card.id] = (acc[card.id] || 0) + drawnCards[cardId];
                        }
                    });
                    return acc;
                }, {});
            }

            sortCards(finalDrawnCards) {
                return Object.entries(finalDrawnCards).map(([key, count]) => {
                    const card = TCGPSimulator.CARD_LIST.find(c => c.id === key);
                    return { card, count };
                }).sort((a, b) => {
                    const rarityComparison = TCGPSimulator.RARITIES.indexOf(b.card.rarity) - TCGPSimulator.RARITIES.indexOf(a.card.rarity);
                    return rarityComparison !== 0 ? rarityComparison : b.count - a.count;
                });
            }

            getOwnedCount(drawCounts, finalDrawnCards) {
                return Object.keys(finalDrawnCards).filter(cardId => {
                    return this.isCardOwned(drawCounts, cardId);
                }).length;
            }

            getTotalCardsInPack(targetPack) {
                const isCompleteAllPacks = $('#completeAllPacks').is(':checked');
                const excludeCrownCards = $('#excludeCrownCards').is(':checked');
                const excludeStarCards = $('#excludeStarCards').is(':checked');

                return isCompleteAllPacks 
                    ? TCGPSimulator.CARD_LIST.filter(card => 
                        card.pack !== 'Unlocked' && (card.pack == targetPack || card.pack == 'All') &&
                        (!excludeCrownCards || card.rarity !== '♛') && 
                        (!excludeStarCards || !card.rarity.startsWith('☆'))
                    ).length 
                    : this.getFilteredCards(targetPack).length;
            }

            saveTotalDays(totalDays) {
                this.totalDaysData.push(totalDays); // Store total days
            }

            updateChart() {
                const counts = this.totalDaysData.sort((a, b) => a - b); // Sort the totalDaysData

                // Prepare data for the chart
                const labels = counts.map((_, index) => `${(index / counts.length * 100).toFixed(0)}%`); // Create labels showing percentage from 0% to 100%

                const ctx = document.getElementById('daysChart').getContext('2d');
                const chartData = {
                    labels: labels, // Use simulation labels
                    datasets: [{
                        label: 'Count of Packs',
                        data: counts, // Use counts for each simulation
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                };

                // Destroy the existing chart if it exists
                if (this.chart) {
                    this.chart.destroy(); // Destroy the previous chart instance
                }

                // Create a new chart
                this.chart = new Chart(ctx, {
                    type: 'bar', // Change to 'line' for a line chart
                    data: chartData,
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        $(document).ready(function () {
            $('#output').DataTable({
                pageLength: 200,
                ordering: false,
                lengthChange: false,
                searching: false,
                paging: false,
                info: false
            });

            $('#runSimulation').on('click', function () {
                $('#output tbody').empty();
                const targetPack = $('#targetPack').val();
                const language = $('#languageSelect').val();
                const numberSimulations = $('#numberSimulations').val();
                const openingSimulator = new TCGPSimulator();
                openingSimulator.runSimulator(numberSimulations, targetPack, language);

                if ($.fn.DataTable.isDataTable('#output')) {
                    $('#output').DataTable().clear();
                }
            });
        });
    </script>

</body>

</html>