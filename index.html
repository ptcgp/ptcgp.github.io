<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon TCG Pocket Unpack Simulator</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
        }

        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }

        h1 {
            color: #333;
        }

        #output {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <h1>Pokemon TCG Pocket Unpack Simulator</h1>

    <div class="checkbox-group">
        <label for="drawUntilAllCardsOwned">Draw Until All Cards Owned in Pack:</label>
        <input type="checkbox" id="drawUntilAllCardsOwned" />
    </div>

    <div class="simulation-group" id="simulationGroup">
        <label for="numberSimulations" id="simulationsLabel">Simulations Count:</label>
        <input type="number" id="numberSimulations" value="10000" min="1" max="10000" />
    </div>

    <div class="checkbox-group" id="dailyQuestGroup" style="display: none;">
        <label for="completeDailyQuest">Complete Daily Quest:</label>
        <input type="checkbox" id="completeDailyQuest" />
    </div>

    <div class="checkbox-group" id="excludeRarityGroup">
        <label for="excludeCrownCards">Exclude Crown ♛ Cards:</label>
        <input type="checkbox" id="excludeCrownCards" />

        <br>

        <label for="excludeStarCards">Exclude Star ☆ Cards:</label>
        <input type="checkbox" id="excludeStarCards" />
    </div>

    <script>
        $(document).ready(function () {
            $('#drawUntilAllCardsOwned').change(function () {
                $('#dailyQuestGroup').toggle(this.checked);
                $('#simulationGroup').toggle(!this.checked); // Hide simulation group if checked
            });
        });
    </script>

    <div class="pack-selection">
        <label for="targetPack">Choose a pack to open:</label>
        <select id="targetPack">
            <option value="Mewtwo">Mewtwo</option>
            <option value="Charizard">Charizard</option>
            <option value="Pikachu">Pikachu</option>
        </select>
    </div>

    <div class="language-selection" style="display: none;">
        <label for="languageSelect">Choose Language:</label>
        <select id="languageSelect">
            <option value="en">English</option>
            <option value="zhhk">正體中文 (香港) - 未完成</option>
        </select>
    </div>

    <button id="runSimulation">Start Unpacking</button>
    <table id="output">
        <div id="opened"></div>
        <div id="owned"></div>
        <thead>
            <tr>
                <th style="text-align: left; width: 25%;">Name</th>
                <th style="text-align: left; width: 25%;">Rarity</th>
                <th style="text-align: left; width: 25%;">Count</th>
            </tr>
        </thead>
        <tbody>
            <!-- Card data will be appended here -->
        </tbody>
    </table>

    <script type="module">
        import { RARITIES, PACK_RATES, DRAW_RATES, CARD_LIST } from './data.js';

        class TCGPSimulator {
            static RARITIES = RARITIES;
            static PACK_RATES = PACK_RATES;
            static DRAW_RATES = DRAW_RATES;
            static CARD_LIST = CARD_LIST;

            openPack(targetPack, language) {
                const drawnCards = {};
                const filteredCards = TCGPSimulator.CARD_LIST.filter(card => card.pack === targetPack || card.pack === 'All');
                const drawRates = TCGPSimulator.DRAW_RATES[Math.random() < TCGPSimulator.PACK_RATES[1] ? 'rare' : 'regular'];

                drawRates.forEach(rate => {
                    const card = this.randomChoice(filteredCards, targetPack, rate);
                    drawnCards[card.id] = (drawnCards[card.id] || 0) + 1;
                });

                return drawnCards;
            }

            runSimulator(numberSimulations = 100, targetPack = 'Charizard', language = 'en') {
                const packsOpenedHistory = [];
                $('#opened').text('');
                const drawUntilAllCardsOwned = $('#drawUntilAllCardsOwned').is(':checked');

                drawUntilAllCardsOwned ? this.simulateUntilAllCardsOwned(packsOpenedHistory, targetPack, language) : this.simulateFixedCount(packsOpenedHistory, numberSimulations, targetPack, language);
                this.updateOutputTable(packsOpenedHistory, targetPack, language);
            }

            simulateUntilAllCardsOwned(packsOpenedHistory, targetPack, language) {
                const ownedCards = new Set();
                let currentCount = 0;

                const filteredCards = this.getFilteredCards(targetPack);
                while (ownedCards.size < filteredCards.length) {
                    const drawnCards = this.openPack(targetPack, language);
                    Object.keys(drawnCards).forEach(cardId => {
                        const card = TCGPSimulator.CARD_LIST.find(c => c.id === cardId);
                        if (this.isCardOwned(card)) ownedCards.add(cardId);
                    });
                    packsOpenedHistory.push(drawnCards);
                    currentCount++;
                    this.updateOpenedCount(currentCount, targetPack);
                }
            }

            simulateFixedCount(packsOpenedHistory, numberSimulations, targetPack, language) {
                for (let i = 0; i < numberSimulations; i++) {
                    packsOpenedHistory.push(this.openPack(targetPack, language));
                }
            }

            updateOpenedCount(currentCount, targetPack) {
                const adjustedPacksPerDay = 2 + ($('#completeDailyQuest').is(':checked') ? (1 / 3) : 0);
                $('#opened').text(`Opened: ${currentCount} (Total Days: ${Math.ceil(currentCount / adjustedPacksPerDay)})`);
            }

            updateOutputTable(packsOpenedHistory, targetPack, language) {
                const finalDrawnCards = this.aggregateDrawnCards(packsOpenedHistory);
                const sortedCards = this.sortCards(finalDrawnCards);
                sortedCards.forEach(({ card, count }) => {
                    $('#output tbody').append(`<tr><td>(${card.id}) ${card[`name-${language}`]}</td><td>${card.rarity}</td><td>${count}</td></tr>`);
                });
                $('#owned').text(`Owned: ${this.getOwnedCount(finalDrawnCards)}/${this.getTotalCardsInPack(targetPack)}`);
                $('#output').append(`</table><br>`);
            }

            randomChoice(array, targetPack, weights) {
                const randomNum = Math.random();
                let cumulativeWeight = 0;
                for (let i = 0; i < array.length; i++) {
                    cumulativeWeight += weights[i];
                    if (randomNum < cumulativeWeight) {
                        const filteredCards = array.filter(card => card.rarity === TCGPSimulator.RARITIES[i]);
                        return filteredCards[Math.floor(Math.random() * filteredCards.length)];
                    }
                }
            }

            getFilteredCards(targetPack) {
                const excludeCrownCards = $('#excludeCrownCards').is(':checked');
                const excludeStarCards = $('#excludeStarCards').is(':checked');
                return TCGPSimulator.CARD_LIST.filter(card =>
                    (card.pack === targetPack || card.pack === 'All') &&
                    (!excludeCrownCards || card.rarity !== '♛') &&
                    (!excludeStarCards || !card.rarity.startsWith('☆'))
                );
            }

            isCardOwned(card) {
                const excludeCrownCards = $('#excludeCrownCards').is(':checked');
                const excludeStarCards = $('#excludeStarCards').is(':checked');
                return (!excludeCrownCards || card.rarity !== '♛') && (!excludeStarCards || !card.rarity.startsWith('☆'));
            }

            aggregateDrawnCards(packsOpenedHistory) {
                return packsOpenedHistory.reduce((acc, drawnCards) => {
                    Object.keys(drawnCards).forEach(cardId => {
                        const card = TCGPSimulator.CARD_LIST.find(c => c.id === cardId);
                        if (card) {
                            acc[card.id] = (acc[card.id] || 0) + drawnCards[cardId];
                        }
                    });
                    return acc;
                }, {});
            }

            sortCards(finalDrawnCards) {
                return Object.entries(finalDrawnCards).map(([key, count]) => {
                    const card = TCGPSimulator.CARD_LIST.find(c => c.id === key);
                    return { card, count };
                }).sort((a, b) => {
                    const rarityComparison = TCGPSimulator.RARITIES.indexOf(b.card.rarity) - TCGPSimulator.RARITIES.indexOf(a.card.rarity);
                    return rarityComparison !== 0 ? rarityComparison : b.count - a.count;
                });
            }

            getOwnedCount(finalDrawnCards) {
                return Object.keys(finalDrawnCards).filter(cardId => {
                    const card = TCGPSimulator.CARD_LIST.find(card => card.id === cardId);
                    return this.isCardOwned(card);
                }).length;
            }

            getTotalCardsInPack(targetPack) {
                return this.getFilteredCards(targetPack).length;
            }
        }
        $(document).ready(function () {
            // Initialize DataTables before the button click
            $('#output').DataTable({
                pageLength: 200, // Set the default showing to 100
                ordering: false, // Disable sorting
                lengthChange: false, // Hide page size select
                searching: false, // Hide search box
                paging: false, // Hide pagination controls
                info: false // Hide footer info
            });

            $('#drawUntilAllCardsOwned').on('change', function () {
                const isChecked = $(this).is(':checked');
                $('#simulationGroup').toggle(!isChecked); // Hide simulation group if checked
            });

            $('#runSimulation').on('click', function () {
                $('#output tbody').empty(); // Clean the table before every run
                const targetPack = $('#targetPack').val(); // Get the selected pack 
                const language = $('#languageSelect').val(); // Get the selected language
                const numberSimulations = $('#numberSimulations').val(); // Get the number of simulations
                const openingSimulator = new TCGPSimulator();
                openingSimulator.runSimulator(numberSimulations, targetPack, language); // Pass the selected pack to run

                // Reset DataTable before initializing
                if ($.fn.DataTable.isDataTable('#output')) {
                    $('#output').DataTable().clear(); // Clear and destroy existing DataTable
                }
            });
        });
    </script>
</body>

</html>